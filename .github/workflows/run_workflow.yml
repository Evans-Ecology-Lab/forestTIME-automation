on:
  schedule:
    - cron: 0 0 1 * * # midnight on 1st of month
  workflow_dispatch: 
    inputs:
      release:
        description: "Make a new GitHub/Zenodo release with this run?"
        required: true
        type: boolean

name: run_workflow.yml

jobs:
  states:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # state: ["DE", "RI"]
        state: ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::dplyr
            any::purrr
            any::nanoparquet
            any::fs
            github::Evans-Ecology-Lab/forestTIME
      
      - name: Generate state parquet
        run: Rscript state-parquet.R
        env:
          STATE: ${{ matrix.state }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.state }}
          path: fia/parquet/*

  release:
  # only happens if schedule or workflow_dispatch with release=TRUE
    if: ${{ (inputs.release && github.event_name == 'workflow_dispatch') || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    needs: states
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: fia/parquet
          merge-multiple: true

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::httr2
            any::purrr
            any::fs
      
      # get artifacts from prev step
      - uses: actions/download-artifact@v5
        with:
          path: "fia/parquet/"

      - name: Create new version and upload to Zenodo
        run: Rscript zenodo-api.R
        env:
          ZENODO_SANDBOX_TOKEN: ${{ secrets.ZENODO_SANDBOX_TOKEN }}
